# nginx/conf.d/eum.conf
# 실제 도메인으로 변경: eum.app → your-domain.com

# ── HTTP → HTTPS 리디렉션 ─────────────────────────────────
server {
    listen 80;
    server_name eum.app www.eum.app;

    # Let's Encrypt 인증 경로
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# ── HTTPS 메인 서버 ────────────────────────────────────────
server {
    listen 443 ssl http2;
    server_name eum.app www.eum.app;

    # ── SSL ───────────────────────────────────────────────
    ssl_certificate     /etc/letsencrypt/live/eum.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/eum.app/privkey.pem;
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_stapling        on;
    ssl_stapling_verify on;

    # ── 보안 헤더 ─────────────────────────────────────────
    add_header X-Frame-Options          "SAMEORIGIN"           always;
    add_header X-Content-Type-Options   "nosniff"              always;
    add_header X-XSS-Protection         "1; mode=block"        always;
    add_header Referrer-Policy          "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy       "camera=(), microphone=(), geolocation=()" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header Content-Security-Policy
        "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self' wss://eum.app; frame-ancestors 'none';"
        always;

    # ── 클라이언트 설정 ───────────────────────────────────
    client_max_body_size 60M;          # 50MB 업로드 + 여유
    client_body_timeout  60s;

    # ── 정적 파일 캐싱 ────────────────────────────────────
    location /_next/static/ {
        alias /app/.next/static/;      # 실제 경로 또는 프록시
        proxy_pass http://eum_app;
        add_header Cache-Control "public, max-age=31536000, immutable";
        access_log off;
    }

    location /favicon.ico {
        proxy_pass http://eum_app;
        add_header Cache-Control "public, max-age=86400";
        access_log off;
    }

    # ── Socket.IO WebSocket ───────────────────────────────
    location /api/socket {
        proxy_pass         http://eum_app;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400s;     # 웹소켓 장기 연결
        proxy_send_timeout 86400s;
    }

    # ── API Rate Limiting ─────────────────────────────────
    location /api/auth/ {
        limit_req zone=auth burst=10 nodelay;
        proxy_pass http://eum_app;
        include /etc/nginx/conf.d/proxy-params.conf;
    }

    location /api/ {
        limit_req zone=api burst=50 nodelay;
        limit_conn addr 20;
        proxy_pass http://eum_app;
        include /etc/nginx/conf.d/proxy-params.conf;
    }

    # ── 일반 요청 ─────────────────────────────────────────
    location / {
        proxy_pass http://eum_app;
        include /etc/nginx/conf.d/proxy-params.conf;
    }
}
